// ---------------- Generator & DB ----------------
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------------- Enums ----------------
enum BookingStatus {
  pending
  complete
  cancel
}

enum Gender {
  male
  female
  other
}

enum PackageType {
  private
  join
}

enum PackageStatus {
  active
  inactive
}

enum TimeSlot {
  morning
  afternoon
}

enum TimeSlotStatus {
  active
  inactive
}

// ---------------- Models ----------------

// ----------- USER ----------------
model User {
  user_id      Int     @id @default(autoincrement())
  username     String  @db.VarChar(30)
  user_fname   String  @db.VarChar(30)
  user_lname   String  @db.VarChar(30)
  email        String  @unique @db.VarChar(50)
  role         String  @db.Char(1)        // "A" | "U" (ตาม cookie teera_user)
  password     String  @db.VarChar(100)
  phone_number String  @db.Char(10)

  bookings     Booking[]

  @@index([role])
}

// ----------- BOAT ----------------
model Boat {
  boat_id    Int      @id @default(autoincrement())
  name       String   @db.VarChar(80)
  capacity   Int
  is_active  Boolean  @default(true)

  packages   Package[]

  created_at DateTime @default(now())
  updated_at DateTime @default(now()) @updatedAt

  @@index([is_active])
}

// ----------- PACKAGE ----------------
model Package {
  package_id             Int           @id @default(autoincrement())
  name                   String        @db.VarChar(120)
  description            String?       @db.Text
  price                  Decimal       @db.Decimal(10, 2)

  boat_id                Int?
  boat                   Boat?         @relation(fields: [boat_id], references: [boat_id])

  type                   PackageType   @default(private)

  time                   Int?          // เวลาประมาณของทริป (นาที) เช่น 240
  spot_count             Int?

  base_member_count      Int           @default(10) // ✅ base สำหรับ 10 คนแรก
  extra_price_per_person Decimal?      @db.Decimal(10, 2)

  status                 PackageStatus @default(active)

  // ✅ timeslots ของ package (มีได้แค่เช้า/บ่าย)
  timeslots              PackageTimeSlot[]

  bookings               Booking[]

  created_at             DateTime      @default(now())
  updated_at             DateTime      @default(now()) @updatedAt

  @@index([boat_id])
  @@index([status])
  @@index([type])
}

// ----------- PACKAGE TIME SLOT ----------------
// จำกัดให้มีแค่ morning / afternoon ด้วย enum TimeSlot
model PackageTimeSlot {
  timeslot_id   Int            @id @default(autoincrement())
  package_id    Int

  slot          TimeSlot       // ✅ morning | afternoon
  max_capacity  Int?           // จำกัดจำนวนคนต่อรอบ (แนะนำสำหรับ join)
  status        TimeSlotStatus @default(active)

  package       Package        @relation(fields: [package_id], references: [package_id])
  bookings      Booking[]

  created_at    DateTime       @default(now())
  updated_at    DateTime       @default(now()) @updatedAt

  @@unique([package_id, slot]) // ✅ 1 package มีเช้าได้ 1 แถว บ่ายได้ 1 แถว
  @@index([package_id])
  @@index([status])
}

// ----------- BOOKING ----------------
model Booking {
  booking_id   Int           @id @default(autoincrement())
  user_id      Int
  package_id   Int
  timeslot_id  Int           // ✅ อ้างถึงรอบ (morning/afternoon)

  trip_date    DateTime
  total_price  Decimal       @db.Decimal(10, 2)
  status       BookingStatus @default(pending)

  created_at   DateTime      @default(now())
  updated_at   DateTime      @default(now()) @updatedAt

  user         User          @relation(fields: [user_id], references: [user_id])
  package      Package       @relation(fields: [package_id], references: [package_id])
  timeslot     PackageTimeSlot @relation(fields: [timeslot_id], references: [timeslot_id])

  passengers   Passenger[]

  @@index([user_id])
  @@index([package_id])
  @@index([timeslot_id])
  @@index([trip_date])
  @@index([status])

  // ✅ สำคัญมาก: ใช้ group join booking รอบเดียวกัน
  @@index([package_id, trip_date, timeslot_id])

  @@map("booking")
}

// ----------- PASSENGER ----------------
model Passenger {
  passenger_id Int      @id @default(autoincrement())
  booking_id   Int

  fname        String   @db.VarChar(60)
  lname        String   @db.VarChar(60)
  age          Int
  gender       Gender

  booking      Booking  @relation(fields: [booking_id], references: [booking_id], onDelete: Cascade)

  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt

  @@index([booking_id])
  @@map("passenger")
}